#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'nasfaa'

command = ARGV[0]
color_arg  = ARGV.grep(/\A--color=/).first
color_mode = color_arg ? color_arg.split('=', 2).last.to_sym : :dark
colorizer = Nasfaa::Colorizer.new(mode: color_mode)

case command
when 'walkthrough'
  require 'io/console'
  puts 'NASFAA Data Sharing Decision Tree — Interactive Walkthrough'
  puts "v#{Nasfaa::VERSION}"
  puts
  puts "Answer each question with 'yes' or 'no' to navigate the decision tree."
  puts "The walkthrough follows the NASFAA PDF's two-page flowchart."

  walkthrough = Nasfaa::Walkthrough.new(colorizer: colorizer)
  walkthrough.run
when 'quiz'
  require 'io/console'
  random = ARGV.include?('--random')
  puts "NASFAA Data Sharing Decision Tree — Quiz Mode#{' (Random)' if random}"
  puts "v#{Nasfaa::VERSION}"
  puts
  puts "Answer 'permit' or 'deny' for each disclosure scenario."

  quiz = Nasfaa::Quiz.new(random: random, colorizer: colorizer)
  quiz.run
when 'evaluate'
  compact = ARGV[1..].reject { |a| a.start_with?('--') }.first
  unless compact
    puts 'Usage: nasfaa evaluate <string>'
    puts
    puts 'Compact string of y/n answers followed by optional p/d assertion.'
    puts 'Example: nasfaa evaluate ynnyp'
    exit 1
  end
  begin
    evaluator = Nasfaa::Evaluate.new(compact, colorizer: colorizer)
    evaluator.run
  rescue ArgumentError => e
    warn "Error: #{e.message}"
    exit 1
  end
  exit 1 if evaluator.passed == false
else
  puts "nasfaa v#{Nasfaa::VERSION}"
  puts
  puts 'Usage: nasfaa <command>'
  puts
  puts 'Commands:'
  puts '  walkthrough        Step through the decision tree interactively'
  puts '  quiz               Test your knowledge with scenario-based questions'
  puts '  evaluate <string>  Evaluate a path through the decision tree'
end
